<!DOCTYPE html>
<html>
<head>
  <title>Ghost Employee Dashboard</title>
  <meta charset="UTF-8">
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background-color: #f4f4f4;
    }
    h1 {
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }
    th, td {
      padding: 0.75rem;
      border: 1px solid #ddd;
    }
    th {
      background-color: #f0f0f0;
    }
    button {
      padding: 0.4rem 0.8rem;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:disabled {
      background-color: #ccc;
    }
  </style>
</head>
<body>
  <div style="overflow: hidden; margin-bottom: 1rem;">
    <h1 style="float: left;">Retry Queue Dashboard</h1>
    <div style="float: right;">
      <a href="/jobs" style="background-color: #343a40; color: white; padding: 6px 12px; margin-left: 8px; text-decoration: none; border-radius: 4px;">ðŸ‘¥ Manage Jobs</a>
      <a href="/add-job" style="background-color: #28a745; color: white; padding: 6px 12px; margin-left: 8px; text-decoration: none; border-radius: 4px;">âž• Add Job</a>
    </div>
  </div>

  <div id="tiles" style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem;">
    <div style="background: #fff; padding: 1rem; border: 1px solid #ddd; flex: 1;">
      <h3>Export Summary</h3>
      <p><strong>Total:</strong> <span id="tile-total">0</span></p>
      <p><strong>Success:</strong> <span id="tile-success">0</span></p>
      <p><strong>Failed:</strong> <span id="tile-failed">0</span></p>
      <p><strong>Pending:</strong> <span id="tile-pending">0</span></p>
    </div>
    <div style="background: #fff; padding: 1rem; border: 1px solid #ddd; flex: 1;">
      <h3>Retry Timing</h3>
      <p><strong>Avg Delay:</strong> <span id="tile-avg-delay">0</span>s</p>
      <p><strong>Max Delay:</strong> <span id="tile-max-delay">0</span>s</p>
      <p><strong>Min Delay:</strong> <span id="tile-min-delay">0</span>s</p>
      <p><strong>Queue Age:</strong> <span id="tile-queue-age">0</span>s</p>
    </div>
    <div style="background: #fff; padding: 1rem; border: 1px solid #ddd; flex: 1;">
      <h3>Target Breakdown</h3>
      <ul id="tile-target-breakdown"></ul>
    </div>
    <div style="background: #fff; padding: 1rem; border: 1px solid #ddd; flex: 1;">
      <h3>Stale Tasks</h3>
      <ul id="tile-stale-tasks"><li>Loading...</li></ul>
    </div>
    <div style="background: #fff; padding: 1rem; border: 1px solid #ddd; flex: 1;">
      <h3>Recent Activity</h3>
      <ul id="tile-recent-activity"><li>Loading...</li></ul>
    </div>
    <div style="background: #fff; padding: 1rem; border: 1px solid #ddd; flex: 1;">
      <h3>Dead-letter Tasks</h3>
      <p><strong>Count:</strong> <span id="tile-dead-count">0</span></p>
      <ul id="tile-dead-list"><li>Loading...</li></ul>
    </div>
    <div style="background: #fff; padding: 1rem; border: 1px solid #ddd; flex: 1;">
      <h3>Ghost Workforce</h3>
      <ul id="tile-ghost-workforce"><li>Loading...</li></ul>
    </div>
  </div>

  <p>Live view of failed export tasks. This page auto-refreshes every 10 seconds.</p>
  <button onclick="clearQueue()" style="margin-bottom: 1rem;">Clear All</button>
  <button onclick="reviveDead()" style="margin-left: 1rem;">Revive All Dead Tasks</button>
  <button onclick="downloadDeadTasks()" style="margin-left: 0.5rem;">Download Dead Tasks</button>

  <table>
    <thead>
      <tr>
        <th>Title</th>
        <th>Target</th>
        <th>Attempts</th>
        <th>Last Attempt</th>
        <th>Result</th>
        <th>Result Time</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="queue-table-body"></tbody>
  </table>

  <script>
    async function fetchTileData() {
      try {
        const [summary, delay, breakdown, stale, recent, dead, jobs] = await Promise.all([
          fetch('/api/tiles/export-summary').then(res => res.json()),
          fetch('/api/tiles/retry-delays').then(res => res.json()),
          fetch('/api/tiles/target-breakdown').then(res => res.json()),
          fetch('/api/tiles/stale-tasks').then(res => res.json()),
          fetch('/api/tiles/recent-activity').then(res => res.json()),
          fetch('/api/tiles/dead-tasks').then(res => res.json()),
          fetch('/api/tiles/job-status').then(res => res.json())
        ]);

        document.getElementById("tile-total").textContent = summary.total;
        document.getElementById("tile-success").textContent = summary.success;
        document.getElementById("tile-failed").textContent = summary.failed;
        document.getElementById("tile-pending").textContent = summary.pending;

        document.getElementById("tile-avg-delay").textContent = delay.average_delay;
        document.getElementById("tile-max-delay").textContent = delay.max_delay;
        document.getElementById("tile-min-delay").textContent = delay.min_delay;
        document.getElementById("tile-queue-age").textContent = delay.queue_age;

        const targetList = document.getElementById("tile-target-breakdown");
        targetList.innerHTML = "";
        for (const target in breakdown) {
          const li = document.createElement("li");
          li.textContent = `${target}: ${breakdown[target]}`;
          targetList.appendChild(li);
        }

        const staleList = document.getElementById("tile-stale-tasks");
        staleList.innerHTML = stale.length
          ? stale.map(s => `<li>${s.title} (${s.hours_ago}h ago)</li>`).join('')
          : "<li>No stale tasks</li>";

        const activityList = document.getElementById("tile-recent-activity");
        activityList.innerHTML = recent.length
          ? recent.map(a => `<li>${a.title} â€“ ${a.status} at ${a.when}</li>`).join('')
          : "<li>No recent activity</li>";

        document.getElementById("tile-dead-count").textContent = dead.count;
        const deadList = document.getElementById("tile-dead-list");
        deadList.innerHTML = dead.titles.length
          ? dead.titles.map(t => `<li>${t}</li>`).join('')
          : "<li>No dead-letter tasks</li>";

        const emojiMap = {
          active: "ðŸŸ¢",
          idle: "ðŸŸ¡",
          error: "ðŸ”´",
          test_mode: "âš™ï¸",
          missing: "â”",
          unknown: "âš«"
        };
        const ghostList = document.getElementById("tile-ghost-workforce");
        ghostList.innerHTML = "";
        jobs.forEach(job => {
          const emoji = emojiMap[job.status] || "âš«";
          const li = document.createElement("li");
          li.textContent = `${emoji} ${job.name} â€“ ${job.status || "unknown"} (${job.last_run || "-"})`;
          ghostList.appendChild(li);
        });
      } catch (e) {
        console.error("Failed to load tile data", e);
      }
    }

    async function fetchQueue() {
      const response = await fetch('/api/retry-queue');
      const queue = await response.json();
      const tbody = document.getElementById('queue-table-body');
      tbody.innerHTML = "";
      queue.forEach((entry, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${entry.task.title || '[No Title]'}</td>
          <td>${entry.target}</td>
          <td>${entry.attempts}</td>
          <td>${entry.last_attempt ? new Date(entry.last_attempt * 1000).toLocaleString() : '-'}</td>
          <td>${entry.retry_result || '-'}</td>
          <td>${entry.result_timestamp ? new Date(entry.result_timestamp * 1000).toLocaleString() : '-'}</td>
          <td><button onclick="retry(${index})">Retry</button></td>
        `;
        tbody.appendChild(row);
      });
      fetchTileData();
    }

    async function retry(index) {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Retrying...';
      await fetch(`/api/retry/${index}`, { method: "POST" });
      await fetchQueue();
    }

    async function clearQueue() {
      if (confirm("Are you sure you want to clear the retry queue?")) {
        await fetch('/api/clear-queue', { method: "POST" });
        await fetchQueue();
      }
    }

    async function reviveDead() {
      if (confirm("Revive all tasks from dead-letter queue?")) {
        const res = await fetch('/api/revive-dead', { method: "POST" });
        const result = await res.json();
        alert(`âœ… Revived ${result.revived} task(s).`);
        await fetchQueue();
      }
    }

    async function downloadDeadTasks() {
      const response = await fetch('/api/download-dead-tasks');
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "dead_tasks.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    }

    fetchQueue();
    setInterval(fetchQueue, 10000);
  </script>
</body>
</html>
